<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ation de Plugins - pcUtils</title>
    <link rel="stylesheet" href="docs_style.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">&larr; Retour √† l'accueil</a>
            <h1>Cr√©ation de Plugins</h1>
            <p class="subtitle">Guide d√©taill√© pour d√©velopper des plugins pcUtils.</p>
        </header>

        <section class="content-section">
            <h2>Introduction</h2>
            <p>Les plugins sont le c≈ìur de pcUtils. Ils encapsulent une t√¢che d'administration sp√©cifique (installer un logiciel, configurer un service, etc.) et peuvent √™tre ex√©cut√©s localement ou √† distance.</p>
            <p>Ce guide explique la structure requise, la configuration via <code>settings.yml</code>, l'√©criture des scripts d'ex√©cution et l'interaction avec l'interface utilisateur.</p>
        </section>

        <section class="content-section">
            <h2>Structure d'un R√©pertoire de Plugin</h2>
            <p>Chaque plugin doit r√©sider dans son propre sous-dossier √† l'int√©rieur du r√©pertoire principal <code>plugins/</code>.</p>
            <pre><code>
pcUtils/
‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îú‚îÄ‚îÄ mon_plugin/             &lt;-- Dossier du plugin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.yml        &lt;-- Configuration et m√©tadonn√©es (Obligatoire)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exec.py             &lt;-- Script d'ex√©cution Python (ou exec.bash/main.sh) (Obligatoire)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py         &lt;-- (Optionnel, pour en faire un package Python)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt    &lt;-- (Optionnel, d√©pendances Python sp√©cifiques)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/          &lt;-- (Optionnel) Dossier pour les templates de config
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ template_bureau.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...                 &lt;-- Autres fichiers n√©cessaires (scripts, configs)
‚îÇ   ‚îî‚îÄ‚îÄ autre_plugin/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ plugins_utils/              &lt;-- Biblioth√®que partag√©e (Optionnelle)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ sequences/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ui/
    ‚îî‚îÄ‚îÄ ...
            </code></pre>
             <p>Le <strong>nom du dossier</strong> (ex: <code>mon_plugin</code>) est important car il est utilis√© comme identifiant interne par d√©faut si le <code>name</code> n'est pas sp√©cifi√© dans <code>settings.yml</code>.</p>
        </section>

        <section class="content-section">
            <h2>Le Fichier <code>settings.yml</code></h2>
            <p>Ce fichier YAML est <strong>obligatoire</strong> et centralise toutes les informations sur le plugin et sa configuration.</p>
            <pre><code>
# Exemple de settings.yml
name: "Installation Serveur Web"      # Nom affich√© dans l'UI (obligatoire)
icon: "üåê"                             # Ic√¥ne affich√©e (optionnel, d√©faut 'üì¶')
description: "Installe et configure Apache ou Nginx." # Description courte (optionnel)

multiple: false                       # (Optionnel) Peut-on ajouter plusieurs fois ce plugin ? (d√©faut: false)
remote_execution: true                # (Optionnel) Ce plugin peut-il √™tre ex√©cut√© via SSH ? (d√©faut: false)
needs_sudo: true                      # (Optionnel) Le script exec.py/main.sh n√©cessite-t-il sudo ? (pour SSH, d√©faut: false)

# (Optionnel) Fichiers dont le contenu sera charg√© et inject√© dans la config
files_content:
  apache_vhost_config: "configs/apache/{vhost_name}.yml" # Chemin relatif au dossier du plugin
                                                         # {vhost_name} sera remplac√© par la valeur du champ 'vhost_name'

# (Optionnel) Fichiers ou motifs √† exclure lors de la copie SSH
excluded_files:
  - "*.log"
  - "secrets.txt"
# Ou ssh_pattern_exceptions: ["*.bak", "temp/"] # Autre nom possible

# (Optionnel) Champs de configuration affich√©s dans l'UI
config_fields:
  # Format Dictionnaire (pr√©f√©r√©)
  webserver_type:                   # ID unique du champ
    type: select                    # Type de champ (voir section suivante)
    label: "Type de serveur web"    # Texte affich√© √† l'utilisateur
    variable: "server_choice"       # (Optionnel) Nom utilis√© dans la config pass√©e √† exec.py (d√©faut: ID du champ)
    options:                        # Options pour le type 'select'
      - ["Apache", "apache"]        # [Label affich√©, Valeur interne]
      - ["Nginx", "nginx"]
    default: "apache"               # Valeur par d√©faut
    required: true                  # Champ obligatoire ? (d√©faut: false)

  vhost_name:
    type: text
    label: "Nom du Virtual Host"
    placeholder: "mondomaine.com"
    depends_on: "webserver_type"    # La valeur d√©pend de webserver_type (simplifie la logique dynamique)
    required: true

  enable_ssl:
    type: checkbox
    label: "Activer HTTPS (SSL/TLS)"
    default: false

  ssl_cert_path:
    type: directory                 # Champ de s√©lection de r√©pertoire
    label: "Chemin du certificat SSL"
    required: true
    enabled_if:                     # S'active seulement si 'enable_ssl' est coch√©
      field: "enable_ssl"           # ID du champ dont d√©pend l'activation
      value: true                   # Valeur requise pour activer ce champ
    # Ou format multiple:
    # enabled_if:
    #   operator: 'AND'             # ou 'OR'
    #   conditions:
    #     - { field: "enable_ssl", value: true }
    #     - { field: "another_field", value: "some_value" }

  admin_email:
    type: text
    label: "Email de l'administrateur"
    required: false

  # Format Liste (moins courant, support√© pour compatibilit√©)
  # - id: php_version
  #   type: select
  #   label: "Version PHP"
  #   options: ["7.4", "8.0", "8.1", "8.2"]
  #   default: "8.1"
            </code></pre>
            <ul>
                <li><span class="config-item">name</span>, <span class="config-item">icon</span>, <span class="config-item">description</span>: M√©tadonn√©es pour l'affichage.</li>
                <li><span class="config-item">multiple</span>: Si <code>true</code>, l'utilisateur peut ajouter plusieurs instances de ce plugin dans l'√©cran de s√©lection.</li>
                <li><span class="config-item">remote_execution</span>: Si <code>true</code>, une case "Activer l'ex√©cution distante" sera ajout√©e √† l'√©cran de configuration, permettant l'ex√©cution via SSH.</li>
                <li><span class="config-item">needs_sudo</span>: Important pour l'ex√©cution SSH. Si <code>true</code>, le script <code>ssh_wrapper.py</code> tentera d'utiliser <code>sudo</code> pour ex√©cuter le script du plugin sur la machine distante.</li>
                <li><span class="config-item">files_content</span>: Tr√®s utile pour injecter des configurations complexes (ex: contenu d'un vhost Apache) dans la variable de configuration pass√©e au script <code>exec.py</code>. Le chemin peut contenir des variables <code>{nom_variable}</code> qui seront remplac√©es par les valeurs des autres champs de configuration. Le contenu du fichier (souvent YAML) est pars√© et inject√©.</li>
                <li><span class="config-item">excluded_files</span> / <span class="config-item">ssh_pattern_exceptions</span>: Liste de noms de fichiers ou motifs (avec <code>*</code>) √† ne pas copier sur la machine distante lors de l'ex√©cution SSH.</li>
                <li><span class="config-item">config_fields</span>: D√©finit le formulaire de configuration. Voir section suivante.</li>
            </ul>
        </section>

        <section class="content-section">
            <h2>D√©finition des Champs de Configuration (`config_fields`)</h2>
            <p>La section <code>config_fields</code> (un dictionnaire ou une liste de dictionnaires) d√©crit les param√®tres que l'utilisateur peut configurer.</p>
            <h3>Attributs Communs</h3>
            <ul>
                <li><span class="config-item">id</span>: Identifiant unique du champ dans le plugin (obligatoire).</li>
                <li><span class="config-item">type</span>: Type du champ (obligatoire). Valeurs possibles :
                    <ul>
                        <li><code>text</code>: Champ de texte simple (<span class="class-name">TextField</span>).</li>
                        <li><code>password</code>: Champ de texte masqu√© (<span class="class-name">PasswordField</span>).</li>
                        <li><code>ip</code>: Champ de texte avec validation d'adresse IP (<span class="class-name">IPField</span>).</li>
                        <li><code>directory</code>: Champ de texte avec bouton "Parcourir" (utilise <code>zenity</code> si disponible) (<span class="class-name">DirectoryField</span>).</li>
                        <li><code>checkbox</code>: Case √† cocher (valeur bool√©enne) (<span class="class-name">CheckboxField</span>).</li>
                        <li><code>select</code>: Liste d√©roulante (<span class="class-name">SelectField</span>). N√©cessite l'attribut <span class="config-item">options</span> ou <span class="config-item">dynamic_options</span>.</li>
                        <li><code>checkbox_group</code>: Groupe de cases √† cocher (<span class="class-name">CheckboxGroupField</span>). N√©cessite <span class="config-item">options</span> ou <span class="config-item">dynamic_options</span>. Retourne une liste des valeurs coch√©es.</li>
                    </ul>
                </li>
                <li><span class="config-item">label</span>: Texte affich√© √† c√¥t√© du champ (obligatoire).</li>
                <li><span class="config-item">variable</span>: (Optionnel) Nom de la cl√© utilis√©e pour cette valeur dans le dictionnaire de configuration final pass√© au script <code>exec.py</code>. Si omis, l'`id` du champ est utilis√©.</li>
                <li><span class="config-item">default</span>: (Optionnel) Valeur par d√©faut du champ.</li>
                <li><span class="config-item">required</span>: (Optionnel, bool) Si <code>true</code>, le champ doit √™tre rempli. Un ast√©risque (*) est ajout√© au label. (D√©faut: <code>false</code>).</li>
                <li><span class="config-item">description</span>: (Optionnel) Texte d'aide affich√© sous le champ.</li>
                <li><span class="config-item">placeholder</span>: (Optionnel, pour les types texte) Texte indicatif affich√© dans le champ vide.</li>
                <li><span class="config-item">enabled_if</span>: (Optionnel) Condition pour activer/d√©sactiver le champ. Voir section D√©pendances.</li>
                <li><span class="config-item">depends_on</span>: (Optionnel) Indique qu'un champ d√©pend d'un autre (ex: pour des valeurs dynamiques li√©es). Voir section D√©pendances.</li>
            </ul>
            <h3>Attributs Sp√©cifiques</h3>
            <ul>
                <li><strong>Pour `select` et `checkbox_group`</strong>:
                    <ul>
                        <li><span class="config-item">options</span>: (Optionnel) Liste statique d'options. Chaque option peut √™tre :
                            <ul>
                                <li>Une liste/tuple: <code>[Label Affich√©, Valeur Interne]</code> (ex: <code>["Apache", "apache"]</code>).</li>
                                <li>Une cha√Æne ou un nombre: Utilis√© comme label et valeur (ex: <code>"8.1"</code>).</li>
                                <li>Un dictionnaire: <code>{description: Label, value: Valeur}</code> ou autres cl√©s comme <code>name</code>, <code>id</code>.</li>
                            </ul>
                        </li>
                        <li><span class="config-item">dynamic_options</span>: (Optionnel) Configuration pour charger les options dynamiquement depuis un script Python. Voir section D√©pendances.</li>
                        <li><span class="config-item">allow_blank</span>: (Optionnel, pour `select`) Si `true`, permet de ne s√©lectionner aucune option. (D√©faut: <code>false</code>).</li>
                         <li><span class="config-item">default_selected</span>: (Optionnel, pour `checkbox_group`) Liste des valeurs qui doivent √™tre coch√©es par d√©faut.</li>
                    </ul>
                </li>
                 <li><strong>Pour `directory`</strong>:
                    <ul>
                        <li><span class="config-item">exists</span>: (Optionnel, bool) Si `true`, valide que le chemin entr√© existe et est un r√©pertoire.</li>
                    </ul>
                </li>
                <li><strong>Pour les types texte</strong>:
                    <ul>
                        <li><span class="config-item">min_length</span> / <span class="config-item">max_length</span>: (Optionnel, int) Longueur minimale/maximale.</li>
                        <li><span class="config-item">validate</span>: (Optionnel) R√®gle de validation simple (ex: <code>no_spaces</code>).</li>
                    </ul>
                </li>
            </ul>
            <h3>D√©pendances entre Champs</h3>
            <ul>
                <li><strong><code>enabled_if</code></strong>: Permet d'activer/d√©sactiver un champ en fonction de la valeur d'un autre.
                    <pre><code>
# Syntaxe Simple
enabled_if:
  field: "autre_champ_id"  # ID du champ de contr√¥le
  value: true             # Valeur requise pour activer ce champ
  remove_if_disabled: false # (Optionnel) Supprimer le champ de l'UI si d√©sactiv√©

# Syntaxe Multiple (avec conditions)
enabled_if:
  operator: 'OR'          # 'AND' (d√©faut) ou 'OR'
  remove_if_disabled: true # (Optionnel)
  conditions:
    - { field: "champ_A", value: "valeur1" }
    - { field: "champ_B", value: false }
                    </code></pre>
                    <span class="file-ref">[<code>config_screen/config_container.py</code>]</span>
                </li>
                <li><strong><code>depends_on</code></strong>: Utilis√© principalement pour d√©clencher la mise √† jour des <code>dynamic_options</code> d'un champ lorsque la valeur d'un autre champ change.
                     <pre><code>
depends_on: "champ_parent_id" # D√©clenche la m√†j quand champ_parent_id change

# Ou format multiple (d√©clenche si l'un des champs change)
depends_on:
  operator: 'OR' # 'AND' est moins courant ici
  fields: ["champ_A", "champ_B"]
                     </code></pre>
                     <span class="file-ref">[<code>config_screen/config_container.py</code>]</span>
                </li>
                <li><strong><code>dynamic_options</code></strong>: Charge les options d'un champ <code>select</code> ou <code>checkbox_group</code> depuis un script Python.
                    <pre><code>
dynamic_options:
  script: "mon_script_options.py" # Nom du script
  function: "get_les_options"     # Nom de la fonction dans le script
  global: false                   # (Optionnel) true si le script est dans /scripts/ (d√©faut: false, cherche dans le dossier plugin)
  path: "@[scripts]"              # (Optionnel) Chemin alternatif. "@[nom_dossier]" cherche dans pcUtils/nom_dossier/
  args:                           # (Optionnel) Arguments √† passer √† la fonction
    - field: "champ_parent_id"    # Passe la valeur de champ_parent_id
      param_name: "filtre"        # Nom du param√®tre dans la fonction Python
    - value: "config_statique"    # Passe une valeur statique
      param_name: "mode"
  # (Optionnel) Cl√©s √† utiliser pour extraire valeur/description si la fonction retourne une liste de dicts
  value: "machine_id"
  description: "hostname"
  # (Optionnel, pour checkbox_group) S√©lectionne automatiquement les options correspondantes
  auto_select_key: "is_default"
  auto_select_value: true # Valeur de auto_select_key qui d√©clenche la s√©lection
                    </code></pre>
                    Le script Python (`mon_script_options.py`) doit contenir la fonction (`get_les_options`). Elle peut accepter les arguments d√©finis (`filtre`, `mode`) et doit retourner une liste au format attendu par le champ (ex: liste de `[Label, Valeur]` ou liste de dictionnaires). <span class="file-ref">[<code>config_screen/select_field.py</code>, <code>config_screen/checkbox_group_field.py</code>]</span>
                </li>
                 <li><strong><code>dynamic_default</code></strong>: (Optionnel) Similaire √† <code>dynamic_options</code>, mais pour charger la valeur par d√©faut d'un champ depuis un script.
                    <pre><code>
dynamic_default:
  script: "get_defaults.py"
  function: "get_default_email"
  args:
    - field: "user_type"
      param_name: "role"
                    </code></pre>
                    <span class="file-ref">[<code>config_screen/config_field.py</code>]</span>
                </li>
            </ul>
        </section>

        <section class="content-section">
            <h2>Script d'Ex√©cution (`exec.py` / `main.sh`)</h2>
            <h3>Plugin Python (`exec.py`)</h3>
            <ul>
                <li>Doit √™tre ex√©cutable (<code>python3 exec.py ...</code>).</li>
                <li>Re√ßoit la configuration via :
                    <ul>
                        <li>Un argument JSON unique : <code>python3 exec.py '{...json...}'</code> (si la config est courte).</li>
                        <li>Un chemin vers un fichier JSON temporaire via l'option <code>-c</code> : <code>python3 exec.py -c /tmp/config.json</code> (si la config est longue ou pour SSH).</li>
                    </ul>
                </li>
                <li>Le script doit parser cet argument (JSON ou fichier) pour acc√©der √† sa configuration. La configuration contient toutes les valeurs des champs d√©finis dans `config_fields` (sous leur nom de `variable` ou `id`), plus potentiellement le contenu des fichiers charg√©s via `files_content`.</li>
                <li><strong>Communication avec l'UI (Crucial)</strong>:
                    <ul>
                        <li>Utiliser la classe <span class="class-name">PluginLogger</span> de la biblioth√®que `plugins_utils`.</li>
                        <li>Initialiser le logger : <code>log = PluginLogger("nom_plugin", instance_id)</code>.</li>
                        <li>Envoyer des logs : <code>log.info("message")</code>, <code>log.error("erreur")</code>, <code>log.warning("...")</code>, <code>log.success("...")</code>.</li>
                        <li>Afficher la progression :
                            <ul>
                                <li>Barre simple : <code>log.progress(percentage=0.5, step=1, total_steps=2)</code> (pourcentage entre 0.0 et 1.0).</li>
                                <li>Barre texte : <code>log.progress_bar_start(total=10, pre_text="Copie")</code>, <code>log.progress_bar_update(current=5, post_text="fichier.txt")</code>, <code>log.progress_bar_stop()</code>.</li>
                            </ul>
                        </li>
                        <li>Ces m√©thodes impriment des lignes JSON format√©es sur `stdout`, qui sont intercept√©es et trait√©es par <span class="class-name">LoggerUtils</span> dans l'UI.</li>
                    </ul>
                    <span class="file-ref">[<code>plugins_utils/plugin_logger.py</code>, <code>execution_screen/logger_utils.py</code>]</span>
                </li>
                <li>Le script doit retourner un code de sortie 0 en cas de succ√®s, et non-z√©ro en cas d'erreur.</li>
            </ul>
            <pre><code>
# Exemple simple d'exec.py
import sys
import json
import argparse
from plugins_utils.plugin_logger import PluginLogger # Assurez-vous que plugins_utils est accessible

def main(config, log):
    log.info("D√©marrage du plugin...")
    server_type = config.get('server_choice', 'inconnu')
    vhost = config.get('vhost_name', 'default')
    log.info(f"Configuration pour {server_type} - vhost: {vhost}")

    # Simuler une t√¢che longue
    for i in range(5):
        log.progress(percentage=(i+1)/5, step=i+1, total_steps=5, status_text=f"√âtape {i+1}")
        # time.sleep(0.5) # Ne pas utiliser time.sleep dans un plugin Textual

    if config.get('enable_ssl'):
        log.info("Configuration SSL activ√©e.")
        cert_path = config.get('ssl_cert_path')
        if not cert_path:
            log.error("Chemin du certificat SSL manquant !")
            return 1 # Code d'erreur

    log.success("Plugin termin√© avec succ√®s.")
    return 0 # Code de succ√®s

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('-c', '--config', help='Path to config file')
    parser.add_argument('config_json', nargs='?', help='Config as JSON string')
    args = parser.parse_args()

    plugin_config = {}
    if args.config:
        try:
            with open(args.config, 'r') as f:
                plugin_config = json.load(f)
        except Exception as e:
            print(f"[ERROR] Failed to load config file: {e}", file=sys.stderr)
            sys.exit(1)
    elif args.config_json:
        try:
            plugin_config = json.loads(args.config_json)
        except Exception as e:
            print(f"[ERROR] Failed to parse JSON config: {e}", file=sys.stderr)
            sys.exit(1)

    # Extraire l'instance_id (peut √™tre dans la config ou d√©duit)
    instance_id = plugin_config.get('instance_id', 0)
    plugin_name = plugin_config.get('plugin_name', 'unknown_plugin')

    # Initialiser le logger
    logger = PluginLogger(plugin_name, instance_id)

    # Ex√©cuter la logique principale
    exit_code = main(plugin_config.get('config', {}), logger) # Passer la sous-config
    sys.exit(exit_code)
            </code></pre>

            <h3>Plugin Bash (`main.sh` ou `exec.bash`)</h3>
             <ul>
                 <li>Doit √™tre ex√©cutable (<code>chmod +x main.sh</code>).</li>
                 <li>Re√ßoit deux arguments : <code>$1</code> = nom du plugin, <code>$2</code> = intensit√© (non utilis√© actuellement).</li>
                 <li>La configuration n'est PAS pass√©e directement. Si des param√®tres sont n√©cessaires, le plugin bash doit les lire depuis un fichier qu'il conna√Æt ou utiliser des variables d'environnement (non standardis√©).</li>
                 <li>La communication avec l'UI (logs, progression) est limit√©e. La sortie standard et d'erreur est captur√©e mais interpr√©t√©e comme du texte brut par d√©faut. Pour une meilleure int√©gration, privil√©gier les plugins Python.</li>
                 <li>Doit retourner un code de sortie 0 pour succ√®s, non-z√©ro pour erreur.</li>
             </ul>
             <pre><code>
#!/bin/bash
PLUGIN_NAME="$1"
INTENSITY="$2" # Non utilis√© pour le moment

echo "[INFO] D√©marrage du plugin Bash: $PLUGIN_NAME"
# ... logique du script ...
ls -l /tmp

if [ $? -eq 0 ]; then
  echo "[SUCCESS] Plugin Bash termin√©."
  exit 0
else
  echo "[ERROR] Erreur dans le plugin Bash." >&2
  exit 1
fi
             </code></pre>
        </section>

        <footer>
            <p>Documentation pcUtils</p>
        </footer>
    </div>
</body>
</html>
